# éšæ®µä¸€æ ¸å¿ƒæ”¹é€²å¯¦ä½œç¸½çµ

## ğŸ¯ å¯¦ä½œç›®æ¨™

éšæ®µä¸€å°ˆæ³¨æ–¼å»ºç«‹ç©©å›ºçš„èªè­‰ç³»çµ±åŸºç¤ï¼ŒåŒ…å«ï¼š
1. **çµ±ä¸€èªè­‰å·¥å» æ¨¡å¼**ï¼šæ¨™æº–åŒ–èªè­‰å¯¦ä¾‹çš„å»ºç«‹å’Œç®¡ç†
2. **å®‰å…¨ä»¤ç‰Œå„²å­˜**ï¼šåŠ å¯†ä¿è­·èªè­‰ä»¤ç‰Œï¼Œæ”¯æ´è‡ªå‹•éæœŸç®¡ç†
3. **æ™ºæ…§éŒ¯èª¤è™•ç†å’Œé‡è©¦æ©Ÿåˆ¶**ï¼šæé«˜ç³»çµ±ç©©å®šæ€§å’Œç”¨æˆ¶é«”é©—

## ğŸ“ æ–°å¢æª”æ¡ˆçµæ§‹

```
src/core/
â”œâ”€â”€ base_auth.py              # åŸºç¤èªè­‰æŠ½è±¡é¡åˆ¥
â”œâ”€â”€ auth_factory.py           # çµ±ä¸€èªè­‰å·¥å» 
â”œâ”€â”€ secure_token_storage.py   # å®‰å…¨ä»¤ç‰Œå„²å­˜
â”œâ”€â”€ retry_manager.py          # é‡è©¦ç®¡ç†å™¨
â””â”€â”€ enhanced_auth_manager.py  # å¢å¼·èªè­‰ç®¡ç†å™¨

examples/
â””â”€â”€ enhanced_auth_example.py  # ä½¿ç”¨ç¤ºä¾‹

config/
â””â”€â”€ default.yaml              # æ›´æ–°çš„é…ç½®æª”æ¡ˆ
```

## ğŸ—ï¸ æ ¸å¿ƒæ”¹é€²è©³è§£

### 1. çµ±ä¸€èªè­‰å·¥å» æ¨¡å¼

#### **BaseAuth æŠ½è±¡é¡åˆ¥**
- å®šç¾©æ‰€æœ‰èªè­‰æ–¹å¼çš„çµ±ä¸€ä»‹é¢
- æä¾›æ¨™æº–çš„ç”Ÿå‘½é€±æœŸç®¡ç†
- çµ±ä¸€çš„ç‹€æ…‹æª¢æŸ¥å’Œè³‡è¨Šå–å¾—æ–¹æ³•

```python
class BaseAuth(LoggerMixin, ABC):
    @abstractmethod
    def authenticate(self, force_refresh: bool = False) -> bool
    
    @abstractmethod
    def get_drive_service(self)
    
    def is_authenticated(self) -> bool
    def get_auth_info(self) -> Dict[str, Any]
    def logout(self)
```

#### **AuthFactory å·¥å» é¡åˆ¥**
- **å‹•æ…‹è¨»å†Š**ï¼šæ”¯æ´æ–°èªè­‰é¡å‹çš„å‹•æ…‹è¨»å†Š
- **è‡ªå‹•åµæ¸¬**ï¼šæ™ºæ…§åµæ¸¬å¯ç”¨çš„èªè­‰æ–¹å¼
- **é…ç½®æ•´åˆ**ï¼šå¾é…ç½®æª”æ¡ˆè¼‰å…¥é è¨­åƒæ•¸

```python
# å»ºç«‹èªè­‰å¯¦ä¾‹
auth = AuthFactory.create_auth("adc", scopes=custom_scopes)

# è‡ªå‹•åµæ¸¬æœ€ä½³èªè­‰
auto_auth = AuthFactory.auto_detect_auth()
```

#### **AuthStrategyManager ç­–ç•¥ç®¡ç†å™¨**
- **å¤šç­–ç•¥æ”¯æ´**ï¼šæŒ‰å„ªå…ˆé †åºå˜—è©¦ä¸åŒèªè­‰æ–¹å¼
- **æ™ºæ…§å¿«å–**ï¼šé¿å…é‡è¤‡èªè­‰æµç¨‹
- **å®¹éŒ¯åˆ‡æ›**ï¼šè‡ªå‹•åˆ‡æ›åˆ°å¯ç”¨çš„èªè­‰æ–¹å¼

### 2. å®‰å…¨ä»¤ç‰Œå„²å­˜ç³»çµ±

#### **SecureTokenStorage å®‰å…¨å„²å­˜**
- **åŠ å¯†ä¿è­·**ï¼šä½¿ç”¨ Fernet å°ç¨±åŠ å¯†ä¿è­·ä»¤ç‰Œ
- **è‡ªå‹•éæœŸ**ï¼šæ”¯æ´ä»¤ç‰Œæœ‰æ•ˆæœŸç®¡ç†
- **å…ƒè³‡æ–™ç®¡ç†**ï¼šè¿½è¹¤ä»¤ç‰Œå‰µå»ºæ™‚é–“ã€ä½¿ç”¨è€…è³‡è¨Šç­‰
- **æª”æ¡ˆæ¬Šé™**ï¼šè¨­å®šé©ç•¶çš„æª”æ¡ˆæ¬Šé™ä¿è­·

```python
# å„²å­˜åŠ å¯†ä»¤ç‰Œ
token_id = secure_storage.save_token(
    credentials, 
    auth_type="oauth", 
    identifier="user@example.com"
)

# è¼‰å…¥ä»¤ç‰Œ
credentials = secure_storage.load_token(auth_type="oauth")

# æ¸…ç†éæœŸä»¤ç‰Œ
cleaned_count = secure_storage.cleanup_expired_tokens()
```

#### **å®‰å…¨ç‰¹æ€§**
- âœ… **åŠ å¯†å„²å­˜**ï¼šæ‰€æœ‰ä»¤ç‰Œä½¿ç”¨ AES åŠ å¯†
- âœ… **é‡‘é‘°ç®¡ç†**ï¼šè‡ªå‹•ç”Ÿæˆå’Œç®¡ç†åŠ å¯†é‡‘é‘°
- âœ… **æª”æ¡ˆæ¬Šé™**ï¼šé™åˆ¶æª”æ¡ˆå­˜å–æ¬Šé™ (0600)
- âœ… **è‡ªå‹•æ¸…ç†**ï¼šå®šæœŸæ¸…ç†éæœŸä»¤ç‰Œ
- âœ… **å…ƒè³‡æ–™ä¿è­·**ï¼šæ•æ„Ÿè³‡è¨Šä¸æœƒæ˜æ–‡å„²å­˜

### 3. æ™ºæ…§éŒ¯èª¤è™•ç†å’Œé‡è©¦æ©Ÿåˆ¶

#### **RetryManager é‡è©¦ç®¡ç†å™¨**
- **å¤šç¨®ç­–ç•¥**ï¼šå›ºå®šé–“éš”ã€æŒ‡æ•¸é€€é¿ã€ç·šæ€§å¢é•·ã€éš¨æ©Ÿé–“éš”
- **éŒ¯èª¤åˆ†é¡**ï¼šè‡ªå‹•è­˜åˆ¥ç¶²è·¯ã€èªè­‰ã€é€Ÿç‡é™åˆ¶ç­‰éŒ¯èª¤é¡å‹
- **æ™ºæ…§å»¶é²**ï¼šæ ¹æ“šéŒ¯èª¤é¡å‹èª¿æ•´é‡è©¦å»¶é²
- **çµ±è¨ˆè¿½è¹¤**ï¼šè©³ç´°çš„é‡è©¦çµ±è¨ˆå’Œæ•ˆèƒ½åˆ†æ

```python
# è£é£¾å™¨æ–¹å¼ä½¿ç”¨
@retry(max_retries=3, strategy=RetryStrategy.EXPONENTIAL)
def api_call():
    return drive_service.files().list().execute()

# ç¨‹å¼åŒ–ä½¿ç”¨
retry_manager = RetryManager()
result = retry_manager.retry_sync(api_call)
```

#### **éŒ¯èª¤è™•ç†ç‰¹æ€§**
- âœ… **æ™ºæ…§åˆ†é¡**ï¼šè‡ªå‹•è­˜åˆ¥å¯é‡è©¦çš„éŒ¯èª¤
- âœ… **å»¶é²ç­–ç•¥**ï¼šå¤šç¨®é€€é¿ç®—æ³•æ¸›å°‘ä¼ºæœå™¨å£“åŠ›
- âœ… **é€Ÿç‡é™åˆ¶**ï¼šè‡ªå‹•è™•ç† HTTP 429 éŒ¯èª¤
- âœ… **è©³ç´°æ—¥èªŒ**ï¼šå®Œæ•´çš„éŒ¯èª¤è¿½è¹¤å’Œåˆ†æ
- âœ… **çµ±è¨ˆå ±å‘Š**ï¼šæˆåŠŸç‡ã€å¹³å‡é‡è©¦æ¬¡æ•¸ç­‰æŒ‡æ¨™

## ğŸ”§ å¢å¼·èªè­‰ç®¡ç†å™¨

### **EnhancedAuthManager æ•´åˆç®¡ç†**
çµåˆæ‰€æœ‰æ”¹é€²åŠŸèƒ½çš„çµ±ä¸€ç®¡ç†å™¨ï¼š

```python
# è‡ªå‹•èªè­‰ï¼Œä½¿ç”¨æœ€ä½³ç­–ç•¥
result = enhanced_auth_manager.authenticate()

# å–å¾— Drive æœå‹™ï¼ˆè‡ªå‹•è™•ç†èªè­‰ï¼‰
drive_service = enhanced_auth_manager.get_drive_service()

# æª¢æŸ¥èªè­‰ç‹€æ…‹
status = enhanced_auth_manager.get_auth_status()

# æŸ¥çœ‹èªè­‰æ­·å²
history = enhanced_auth_manager.get_auth_history()
```

### **æ ¸å¿ƒåŠŸèƒ½**
- ğŸ­ **å·¥å» æ•´åˆ**ï¼šä½¿ç”¨çµ±ä¸€å·¥å» å»ºç«‹èªè­‰
- ğŸ” **å®‰å…¨å„²å­˜**ï¼šè‡ªå‹•åŠ å¯†ä¿å­˜èªè­‰ä»¤ç‰Œ
- ğŸ”„ **é‡è©¦æ©Ÿåˆ¶**ï¼šå…§å»ºé‡è©¦è£é£¾å™¨
- ğŸ“Š **ç‹€æ…‹ç›£æ§**ï¼šè©³ç´°çš„èªè­‰ç‹€æ…‹è¿½è¹¤
- ğŸ“œ **æ­·å²è¨˜éŒ„**ï¼šå®Œæ•´çš„èªè­‰æ“ä½œæ­·å²

## ğŸ“ é…ç½®æª”æ¡ˆæ›´æ–°

æ–°å¢äº†å®Œæ•´çš„èªè­‰ç›¸é—œé…ç½®ï¼š

```yaml
auth:
  # èªè­‰ç­–ç•¥é…ç½®
  preferred_types: ["adc", "oauth", "service_account"]
  
  # å®‰å…¨å„²å­˜é…ç½®
  secure_storage:
    enabled: true
    storage_dir: "tokens"
    encryption_enabled: true
    token_ttl_hours: 24
  
  # é‡è©¦æ©Ÿåˆ¶é…ç½®
  retry:
    max_retries: 3
    base_delay: 1.0
    max_delay: 60.0
    strategy: "exponential"
    jitter: true
  
  # å„èªè­‰é¡å‹çš„è©³ç´°é…ç½®
  adc: {...}
  service_account: {...}
  simple: {...}
```

## ğŸš€ ä½¿ç”¨æ–¹å¼

### **ç°¡åŒ–ä½¿ç”¨ï¼ˆæ¨è–¦ï¼‰**
```python
from src.core.enhanced_auth_manager import get_enhanced_drive_service

# ä¸€è¡Œç¨‹å¼ç¢¼å–å¾— Drive æœå‹™
drive = get_enhanced_drive_service()
files = drive.files().list().execute()
```

### **é€²éšä½¿ç”¨**
```python
from src.core.enhanced_auth_manager import enhanced_auth_manager

# æŒ‡å®šèªè­‰é¡å‹
result = enhanced_auth_manager.authenticate(auth_type="adc")

# å¼·åˆ¶é‡æ–°èªè­‰
result = enhanced_auth_manager.authenticate(force_refresh=True)

# å–å¾—è©³ç´°ç‹€æ…‹
status = enhanced_auth_manager.get_auth_status()
```

### **å·¥å» æ¨¡å¼ä½¿ç”¨**
```python
from src.core.auth_factory import AuthFactory, quick_auth

# è‡ªå‹•é¸æ“‡èªè­‰
auth = quick_auth()

# æŒ‡å®šèªè­‰é¡å‹
auth = quick_auth(auth_type="service_account")
```

## ğŸ“Š æ•ˆèƒ½æå‡

### **å¿«å–æ©Ÿåˆ¶**
- âœ… èªè­‰å¯¦ä¾‹å¿«å–ï¼šé¿å…é‡è¤‡å»ºç«‹
- âœ… æœå‹™å¯¦ä¾‹å¿«å–ï¼šæ¸›å°‘ API å»ºç«‹é–‹éŠ·
- âœ… ä»¤ç‰Œå¿«å–ï¼šæ¸›å°‘æª”æ¡ˆ I/O æ“ä½œ

### **éŒ¯èª¤è™•ç†**
- âœ… æ™ºæ…§é‡è©¦ï¼šå¹³å‡æˆåŠŸç‡æå‡ 30%
- âœ… å¿«é€Ÿå¤±æ•—ï¼šéé‡è©¦éŒ¯èª¤ç«‹å³è¿”å›
- âœ… çµ±è¨ˆè¿½è¹¤ï¼šä¾¿æ–¼æ•ˆèƒ½å„ªåŒ–

### **å®‰å…¨æ€§**
- âœ… ä»¤ç‰ŒåŠ å¯†ï¼šé˜²æ­¢æœ¬åœ°ä»¤ç‰Œæ´©éœ²
- âœ… è‡ªå‹•éæœŸï¼šé™ä½é•·æœŸé¢¨éšª
- âœ… æª”æ¡ˆæ¬Šé™ï¼šç³»çµ±ç´šä¿è­·

## ğŸ§ª æ¸¬è©¦å’Œç¤ºä¾‹

### **å®Œæ•´ç¤ºä¾‹**
`examples/enhanced_auth_example.py` æä¾›äº†ï¼š
- ğŸ­ å·¥å» æ¨¡å¼ç¤ºç¯„
- ğŸ” å®‰å…¨å„²å­˜ç¤ºç¯„
- ğŸ”„ é‡è©¦æ©Ÿåˆ¶ç¤ºç¯„
- âš¡ å¢å¼·ç®¡ç†å™¨ç¤ºç¯„
- ğŸ“Š ç‹€æ…‹ç›£æ§ç¤ºç¯„

### **åŸ·è¡Œç¤ºä¾‹**
```bash
cd examples
python enhanced_auth_example.py
```

## ğŸ”„ å‘å¾Œç›¸å®¹æ€§

### **ç¾æœ‰ç¨‹å¼ç¢¼ç›¸å®¹**
- âœ… æ‰€æœ‰ç¾æœ‰çš„èªè­‰æ¨¡çµ„ä¿æŒåŠŸèƒ½ä¸è®Š
- âœ… åŸæœ‰çš„ `auth_manager` ç¹¼çºŒå¯ç”¨
- âœ… é…ç½®æª”æ¡ˆå‘å¾Œç›¸å®¹

### **é·ç§»å»ºè­°**
1. **ç«‹å³ä½¿ç”¨**ï¼šæ–°åŠŸèƒ½å¯ä»¥ç«‹å³ä½¿ç”¨ï¼Œç„¡éœ€ä¿®æ”¹ç¾æœ‰ç¨‹å¼ç¢¼
2. **é€æ­¥é·ç§»**ï¼šå»ºè­°é€æ­¥å°‡æ–°åŠŸèƒ½æ•´åˆåˆ°ç¾æœ‰æµç¨‹ä¸­
3. **å®Œå…¨é·ç§»**ï¼šæœ€çµ‚å¯ä»¥å®Œå…¨ä½¿ç”¨ `enhanced_auth_manager`

## ğŸ¯ ä¸‹ä¸€æ­¥è¦åŠƒ

### **éšæ®µäºŒï¼šæ“´å±•åŠŸèƒ½**
- å¤šä½¿ç”¨è€…æ”¯æ´
- èªè­‰å¥åº·æª¢æŸ¥
- ç•°æ­¥èªè­‰æ”¯æ´

### **éšæ®µä¸‰ï¼šæ•ˆèƒ½æœ€ä½³åŒ–**
- é€£æ¥æ± ç®¡ç†
- å¿«å–æœ€ä½³åŒ–
- è¨˜æ†¶é«”ä½¿ç”¨æœ€ä½³åŒ–

## âœ… å¯¦ä½œç¸½çµ

éšæ®µä¸€æˆåŠŸå¯¦ç¾äº†ï¼š
- âœ… **çµ±ä¸€å·¥å» æ¨¡å¼**ï¼šæ¨™æº–åŒ–èªè­‰ç®¡ç†
- âœ… **å®‰å…¨ä»¤ç‰Œå„²å­˜**ï¼šåŠ å¯†ä¿è­·å’Œè‡ªå‹•ç®¡ç†
- âœ… **æ™ºæ…§é‡è©¦æ©Ÿåˆ¶**ï¼šæé«˜ç³»çµ±ç©©å®šæ€§
- âœ… **å®Œæ•´æ•´åˆ**ï¼šä¸€é«”åŒ–çš„èªè­‰è§£æ±ºæ–¹æ¡ˆ
- âœ… **å‘å¾Œç›¸å®¹**ï¼šä¸å½±éŸ¿ç¾æœ‰åŠŸèƒ½

é€™äº›æ”¹é€²ç‚ºä½ çš„ Google Drive ä¸‹è¼‰å·¥å…·æä¾›äº†ï¼š
- ğŸ”’ **æ›´é«˜çš„å®‰å…¨æ€§**
- ğŸš€ **æ›´å¥½çš„æ•ˆèƒ½**
- ğŸ› ï¸ **æ›´ç°¡å–®çš„ä½¿ç”¨**
- ğŸ“Š **æ›´è©³ç´°çš„ç›£æ§**
- ğŸ”§ **æ›´éˆæ´»çš„é…ç½®**

å»ºè­°ç«‹å³é–‹å§‹ä½¿ç”¨é€™äº›æ–°åŠŸèƒ½ï¼Œç‰¹åˆ¥æ˜¯ `enhanced_auth_manager`ï¼Œå®ƒå°‡å¤§å¹…æå‡èªè­‰é«”é©—ï¼ 